import _typeof from "@babel/runtime/helpers/typeof";
import _objectSpread from "@babel/runtime/helpers/objectSpread2";
import _asyncToGenerator from "@babel/runtime/helpers/asyncToGenerator";
import _slicedToArray from "@babel/runtime/helpers/slicedToArray";
import _regeneratorRuntime from "@babel/runtime/regenerator";
import React, { useRef, useEffect, useImperativeHandle, useState, useMemo } from 'react';
import CodeMirror from 'codemirror';
import 'codemirror/mode/meta';
import './codemirror.css';
var defaultOptions = {
  tabSize: 2,
  autoCloseBrackets: true,
  matchBrackets: true,
  showCursorWhenSelecting: true,
  // 显示行号
  lineNumbers: true,
  fullScreen: true
};

function ReactCodeMirror() {
  var props = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
  var ref = arguments.length > 1 ? arguments[1] : undefined;
  var _props$options = props.options,
      options = _props$options === void 0 ? {} : _props$options,
      _props$value = props.value,
      value = _props$value === void 0 ? '' : _props$value,
      _props$width = props.width,
      width = _props$width === void 0 ? '100%' : _props$width,
      _props$height = props.height,
      height = _props$height === void 0 ? '100%' : _props$height,
      _props$lazyLoadMode = props.lazyLoadMode,
      lazyLoadMode = _props$lazyLoadMode === void 0 ? true : _props$lazyLoadMode;

  var _useState = useState(),
      _useState2 = _slicedToArray(_useState, 2),
      editor = _useState2[0],
      setEditor = _useState2[1];

  var textareaRef = useRef();
  var lastestProps = useRef(props);
  useImperativeHandle(ref, function () {
    return {
      editor: editor
    };
  }, [editor]);
  lastestProps.current = props; // 将props中所有的事件处理函数映射并保存

  function getEventHandleFromProps() {
    var propNames = Object.keys(props);
    var eventHandle = propNames.filter(function (keyName) {
      return /^on+/.test(keyName);
    });
    var eventDict = {};
    eventHandle.forEach(function (ele) {
      var name = ele.slice(2);

      if (name && name[0]) {
        eventDict[ele] = name.replace(name[0], name[0].toLowerCase());
      }
    });
    return eventDict;
  } // http://codemirror.net/doc/manual.html#config


  function setOptions(_x) {
    return _setOptions.apply(this, arguments);
  }

  function _setOptions() {
    _setOptions = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee(instance) {
      var opt,
          mode,
          _args = arguments;
      return _regeneratorRuntime.wrap(function _callee$(_context) {
        while (1) {
          switch (_context.prev = _context.next) {
            case 0:
              opt = _args.length > 1 && _args[1] !== undefined ? _args[1] : {};

              if (!(_typeof(opt) === 'object' && window)) {
                _context.next = 8;
                break;
              }

              mode = CodeMirror.findModeByName(opt.mode || '');

              if (!(lazyLoadMode && mode && mode.mode)) {
                _context.next = 6;
                break;
              }

              _context.next = 6;
              return import("codemirror/mode/".concat(mode.mode, "/").concat(mode.mode, ".js"));

            case 6:
              if (mode) {
                opt.mode = mode.mime;
              }

              Object.keys(opt).forEach(function (name) {
                if ((opt[name] || opt[name] === false) && JSON.stringify(opt[name])) {
                  instance.setOption(name, opt[name]);
                }
              });

            case 8:
            case "end":
              return _context.stop();
          }
        }
      }, _callee);
    }));
    return _setOptions.apply(this, arguments);
  }

  useEffect(function () {
    if (!editor && window) {
      // 生成codemirror实例
      var instance = CodeMirror.fromTextArea(textareaRef.current, _objectSpread(_objectSpread({}, defaultOptions), options));
      var eventDict = getEventHandleFromProps();
      Object.keys(eventDict).forEach(function (event) {
        instance.on(eventDict[event], function () {
          var _lastestProps$current;

          return (_lastestProps$current = lastestProps.current)[event].apply(_lastestProps$current, arguments);
        });
      });
      instance.setValue(value || '');

      if (width || height) {
        // 设置尺寸
        instance.setSize(width, height);
      }

      setEditor(instance);
      setOptions(instance, _objectSpread(_objectSpread({}, defaultOptions), options));
    }

    return function () {
      if (editor && window) {
        editor.toTextArea();
        setEditor(undefined);
      }
    };
  }, []);
  useMemo(function () {
    if (!editor || !window) return;
    var val = editor.getValue();

    if (value !== undefined && value !== val) {
      editor.setValue(value);
    }
  }, [value]);
  useMemo(function () {
    if (!editor || !window) return;
    editor.setSize(width, height);
  }, [width, height]);
  useMemo(function () {
    if (!editor || !window) return;
    setOptions(editor, _objectSpread(_objectSpread({}, defaultOptions), options));
  }, [editor, options]);
  return /*#__PURE__*/React.createElement("textarea", {
    ref: textareaRef
  });
}

export default /*#__PURE__*/React.forwardRef(ReactCodeMirror);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJSZWFjdCIsInVzZVJlZiIsInVzZUVmZmVjdCIsInVzZUltcGVyYXRpdmVIYW5kbGUiLCJ1c2VTdGF0ZSIsInVzZU1lbW8iLCJDb2RlTWlycm9yIiwiZGVmYXVsdE9wdGlvbnMiLCJ0YWJTaXplIiwiYXV0b0Nsb3NlQnJhY2tldHMiLCJtYXRjaEJyYWNrZXRzIiwic2hvd0N1cnNvcldoZW5TZWxlY3RpbmciLCJsaW5lTnVtYmVycyIsImZ1bGxTY3JlZW4iLCJSZWFjdENvZGVNaXJyb3IiLCJwcm9wcyIsInJlZiIsIm9wdGlvbnMiLCJ2YWx1ZSIsIndpZHRoIiwiaGVpZ2h0IiwibGF6eUxvYWRNb2RlIiwiZWRpdG9yIiwic2V0RWRpdG9yIiwidGV4dGFyZWFSZWYiLCJsYXN0ZXN0UHJvcHMiLCJjdXJyZW50IiwiZ2V0RXZlbnRIYW5kbGVGcm9tUHJvcHMiLCJwcm9wTmFtZXMiLCJPYmplY3QiLCJrZXlzIiwiZXZlbnRIYW5kbGUiLCJmaWx0ZXIiLCJrZXlOYW1lIiwidGVzdCIsImV2ZW50RGljdCIsImZvckVhY2giLCJlbGUiLCJuYW1lIiwic2xpY2UiLCJyZXBsYWNlIiwidG9Mb3dlckNhc2UiLCJzZXRPcHRpb25zIiwiaW5zdGFuY2UiLCJvcHQiLCJ3aW5kb3ciLCJtb2RlIiwiZmluZE1vZGVCeU5hbWUiLCJtaW1lIiwiSlNPTiIsInN0cmluZ2lmeSIsInNldE9wdGlvbiIsImZyb21UZXh0QXJlYSIsImV2ZW50Iiwib24iLCJzZXRWYWx1ZSIsInNldFNpemUiLCJ0b1RleHRBcmVhIiwidW5kZWZpbmVkIiwidmFsIiwiZ2V0VmFsdWUiLCJmb3J3YXJkUmVmIl0sIm1hcHBpbmdzIjoiOzs7OztBQUFBLE9BQU9BLEtBQVAsSUFBZ0JDLE1BQWhCLEVBQXdCQyxTQUF4QixFQUFtQ0MsbUJBQW5DLEVBQXdEQyxRQUF4RCxFQUFrRUMsT0FBbEUsUUFBaUYsT0FBakY7QUFDQSxPQUFPQyxVQUFQLE1BQXVCLFlB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QUFDRCxHQUhNLEVBR0osQ0FBQ0QsS0FBRCxFQUFRQyxNQUFSLENBSEksQ0FBUDtBQU1BZixFQUFBQSxPQUFPLENBQUMsWUFBTTtBQUNaLFFBQUksQ0FBQ2lCLE1BQUQsSUFBVyxDQUFDdUIsTUFBaEIsRUFBd0I7QUFDeEJILElBQUFBLFVBQVUsQ0FBQ3BCLE1BQUQsa0NBQWFmLGNBQWIsR0FBZ0NVLE9BQWhDLEVBQVY7QUFDRCxHQUhNLEVBR0osQ0FBQ0ssTUFBRCxFQUFTTCxPQUFULENBSEksQ0FBUDtBQUtBLHNCQUNFO0FBQVUsSUFBQSxHQUFHLEVBQUVPO0FBQWYsSUFERjtBQUdEOztBQUVELDRCQUFleEIsS0FBSyxDQUFDNkQsVUFBTixDQUFpQi9DLGVBQWpCLENBQWYiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVhY3QsIHsgdXNlUmVmLCB1c2VFZmZlY3QsIHVzZUltcGVyYXRpdmVIYW5kbGUsIHVzZVN0YXRlLCB1c2VNZW1vIH0gZnJvbSAncmVhY3QnO1xuaW1wb3J0IENvZGVNaXJyb3IgZnJvbSAnY29kZW1pcnJvcic7XG5pbXBvcnQgJ2NvZGVtaXJyb3IvbW9kZS9tZXRhJztcbmltcG9ydCAnLi9jb2RlbWlycm9yLmNzcyc7XG5cbmNvbnN0IGRlZmF1bHRPcHRpb25zID0ge1xuICB0YWJTaXplOiAyLFxuICBhdXRvQ2xvc2VCcmFja2V0czogdHJ1ZSxcbiAgbWF0Y2hCcmFja2V0czogdHJ1ZSxcbiAgc2hvd0N1cnNvcldoZW5TZWxlY3Rpbmc6IHRydWUsXG4gIC8vIOaYvuekuuihjOWPt1xuICBsaW5lTnVtYmVyczogdHJ1ZSxcbiAgZnVsbFNjcmVlbjogdHJ1ZSxcbn1cblxuZnVuY3Rpb24gUmVhY3RDb2RlTWlycm9yKHByb3BzID0ge30sIHJlZikge1xuICBjb25zdCB7IG9wdGlvbnMgPSB7fSwgdmFsdWUgPSAnJywgd2lkdGggPSAnMTAwJScsIGhlaWdodCA9ICcxMDAlJywgbGF6eUxvYWRNb2RlID0gdHJ1ZSB9ID0gcHJvcHM7XG4gIGNvbnN0IFtlZGl0b3IsIHNldEVkaXRvcl0gPSB1c2VTdGF0ZSgpO1xuICBjb25zdCB0ZXh0YXJlYVJlZiA9IHVzZVJlZigpO1xuICBjb25zdCBsYXN0ZXN0UHJvcHMgPSB1c2VSZWYocHJvcHMpO1xuXG4gIHVzZUltcGVyYXRpdmVIYW5kbGUocmVmLCAoKSA9PiAoeyBlZGl0b3IgfSksIFtlZGl0b3JdKTtcbiAgbGFzdGVzdFByb3BzLmN1cnJlbnQgPSBwcm9wcztcbiAgXG4gIC8vIOWwhnByb3Bz5Lit5omA5pyJ55qE5LqL5Lu25aSE55CG5Ye95pWw5pig5bCE5bm25L+d5a2YXG4gIGZ1bmN0aW9uIGdldEV2ZW50SGFuZGxlRnJvbVByb3BzKCkge1xuICAgIGNvbnN0IHByb3BOYW1lcyA9IE9iamVjdC5rZXlzKHByb3BzKTtcbiAgICBjb25zdCBldmVudEhhbmRsZSA9IHByb3BOYW1lcy5maWx0ZXIoKGtleU5hbWUpID0+IHtcbiAgICAgIHJldHVybiAvXm9uKy8udGVzdChrZXlOYW1lKTtcbiAgICB9KTtcblxuICAgIGNvbnN0IGV2ZW50RGljdCA9IHt9O1xuICAgIGV2ZW50SGFuZGxlLmZvckVhY2goKGVsZSkgPT4ge1xuICAgICAgY29uc3QgbmFtZSA9IGVsZS5zbGljZSgyKTtcbiAgICAgIGlmIChuYW1lICYmIG5hbWVbMF0pIHtcbiAgICAgICAgZXZlbnREaWN0W2VsZV0gPSBuYW1lLnJlcGxhY2UobmFtZVswXSwgbmFtZVswXS50b0xvd2VyQ2FzZSgpKTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHJldHVybiBldmVudERpY3Q7XG4gIH1cblxuICAvLyBodHRwOi8vY29kZW1pcnJvci5uZXQvZG9jL21hbnVhbC5odG1sI2NvbmZpZ1xuICBhc3luYyBmdW5jdGlvbiBzZXRPcHRpb25zKGluc3RhbmNlLCBvcHQgPSB7fSkge1xuICAgIGlmICh0eXBlb2Ygb3B0ID09PSAnb2JqZWN0JyAmJiB3aW5kb3cpIHtcbiAgICAgIGNvbnN0IG1vZGUgPSBDb2RlTWlycm9yLmZpbmRNb2RlQnlOYW1lKG9wdC5tb2RlIHx8ICcnKTtcbiAgICAgIGlmIChsYXp5TG9hZE1vZGUgJiYgbW9kZSAmJiBtb2RlLm1vZGUpIHtcbiAgICAgICAgYXdhaXQgaW1wb3J0KGBjb2RlbWlycm9yL21vZGUvJHttb2RlLm1vZGV9LyR7bW9kZS5tb2RlfS5qc2ApO1xuICAgICAgfVxuICAgICAgaWYgKG1vZGUpIHtcbiAgICAgICAgb3B0Lm1vZGUgPSBtb2RlLm1pbWU7XG4gICAgICB9XG4gICAgICBPYmplY3Qua2V5cyhvcHQpLmZvckVhY2goKG5hbWUpID0+IHtcbiAgICAgICAgaWYgKChvcHRbbmFtZV0gfHwgb3B0W25hbWVdID09PSBmYWxzZSkgJiYgSlNPTi5zdHJpbmdpZnkob3B0W25hbWVdKSkge1xuICAgICAgICAgIGluc3RhbmNlLnNldE9wdGlvbihuYW1lLCBvcHRbbmFtZV0pO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICB1c2VFZmZlY3QoKCkgPT4ge1xuICAgIGlmICghZWRpdG9yICYmIHdpbmRvdykge1xuICAgICAgLy8g55Sf5oiQY29kZW1pcnJvcuWunuS+i1xuICAgICAgY29uc3QgaW5zdGFuY2UgPSBDb2RlTWlycm9yLmZyb21UZXh0QXJlYSh0ZXh0YXJlYVJlZi5jdXJyZW50LCB7Li4uZGVmYXVsdE9wdGlvbnMsIC4uLm9wdGlvbnN9KTtcbiAgICAgIGNvbnN0IGV2ZW50RGljdCA9IGdldEV2ZW50SGFuZGxlRnJvbVByb3BzKCk7XG4gICAgICBPYmplY3Qua2V5cyhldmVudERpY3QpLmZvckVhY2goKGV2ZW50KSA9PiB7XG4gICAgICAgIGluc3RhbmNlLm9uKGV2ZW50RGljdFtldmVudF0sICguLi5wYXJhbXMpID0+IGxhc3Rlc3RQcm9wcy5jdXJyZW50W2V2ZW50XSguLi5wYXJhbXMpKTtcbiAgICAgIH0pO1xuICAgICAgaW5zdGFuY2Uuc2V0VmFsdWUodmFsdWUgfHwgJycpO1xuXG4gICAgICBpZiAod2lkdGggfHwgaGVpZ2h0KSB7XG4gICAgICAgIC8vIOiuvue9ruWwuuWvuFxuICAgICAgICBpbnN0YW5jZS5zZXRTaXplKHdpZHRoLCBoZWlnaHQpO1xuICAgICAgfVxuICAgICAgc2V0RWRpdG9yKGluc3RhbmNlKTtcbiAgICAgIHNldE9wdGlvbnMoaW5zdGFuY2UsIHsuLi5kZWZhdWx0T3B0aW9ucywgLi4ub3B0aW9uc30pO1xuICAgIH1cbiAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgaWYgKGVkaXRvciAmJiB3aW5kb3cpIHtcbiAgICAgICAgZWRpdG9yLnRvVGV4dEFyZWEoKTtcbiAgICAgICAgc2V0RWRpdG9yKHVuZGVmaW5lZCk7XG4gICAgICB9XG4gICAgfVxuICB9LCBbXSk7XG5cbiAgdXNlTWVtbygoKSA9PiB7XG4gICAgaWYgKCFlZGl0b3IgfHwgIXdpbmRvdykgcmV0dXJuO1xuICAgIGNvbnN0IHZhbCA9IGVkaXRvci5nZXRWYWx1ZSgpO1xuICAgIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkICYmIHZhbHVlICE9PSB2YWwpIHtcbiAgICAgIGVkaXRvci5zZXRWYWx1ZSh2YWx1ZSk7XG4gICAgfVxuICB9LCBbdmFsdWVdKTtcblxuICB1c2VNZW1vKCgpID0+IHtcbiAgICBpZiAoIWVkaXRvciB8fCAhd2luZG93KSByZXR1cm47XG4gICAgZWRpdG9yLnNldFNpemUod2lkdGgsIGhlaWdodCk7XG4gIH0sIFt3aWR0aCwgaGVpZ2h0XSk7XG5cblxuICB1c2VNZW1vKCgpID0+IHtcbiAgICBpZiAoIWVkaXRvciB8fCAhd2luZG93KSByZXR1cm47XG4gICAgc2V0T3B0aW9ucyhlZGl0b3IsIHsuLi5kZWZhdWx0T3B0aW9ucywgLi4ub3B0aW9uc30pO1xuICB9LCBbZWRpdG9yLCBvcHRpb25zXSk7XG4gIFxuICByZXR1cm4gKFxuICAgIDx0ZXh0YXJlYSByZWY9e3RleHRhcmVhUmVmfSAvPlxuICApO1xufVxuXG5leHBvcnQgZGVmYXVsdCBSZWFjdC5mb3J3YXJkUmVmKFJlYWN0Q29kZU1pcnJvcik7XG4iXX0=