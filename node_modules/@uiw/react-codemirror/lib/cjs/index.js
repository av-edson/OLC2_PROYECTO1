"use strict";

var _interopRequireWildcard3 = require("@babel/runtime/helpers/interopRequireWildcard").default;

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault").default;

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _regenerator = _interopRequireDefault(require("@babel/runtime/regenerator"));

var _interopRequireWildcard2 = _interopRequireDefault(require("@babel/runtime/helpers/interopRequireWildcard"));

var _typeof2 = _interopRequireDefault(require("@babel/runtime/helpers/typeof"));

var _objectSpread2 = _interopRequireDefault(require("@babel/runtime/helpers/objectSpread2"));

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _react = _interopRequireWildcard3(require("react"));

var _codemirror = _interopRequireDefault(require("codemirror"));

require("codemirror/mode/meta");

var defaultOptions = {
  tabSize: 2,
  autoCloseBrackets: true,
  matchBrackets: true,
  showCursorWhenSelecting: true,
  // 显示行号
  lineNumbers: true,
  fullScreen: true
};

function ReactCodeMirror() {
  var props = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
  var ref = arguments.length > 1 ? arguments[1] : undefined;
  var _props$options = props.options,
      options = _props$options === void 0 ? {} : _props$options,
      _props$value = props.value,
      value = _props$value === void 0 ? '' : _props$value,
      _props$width = props.width,
      width = _props$width === void 0 ? '100%' : _props$width,
      _props$height = props.height,
      height = _props$height === void 0 ? '100%' : _props$height,
      _props$lazyLoadMode = props.lazyLoadMode,
      lazyLoadMode = _props$lazyLoadMode === void 0 ? true : _props$lazyLoadMode;

  var _useState = (0, _react.useState)(),
      _useState2 = (0, _slicedToArray2.default)(_useState, 2),
      editor = _useState2[0],
      setEditor = _useState2[1];

  var textareaRef = (0, _react.useRef)();
  var lastestProps = (0, _react.useRef)(props);
  (0, _react.useImperativeHandle)(ref, function () {
    return {
      editor: editor
    };
  }, [editor]);
  lastestProps.current = props; // 将props中所有的事件处理函数映射并保存

  function getEventHandleFromProps() {
    var propNames = Object.keys(props);
    var eventHandle = propNames.filter(function (keyName) {
      return /^on+/.test(keyName);
    });
    var eventDict = {};
    eventHandle.forEach(function (ele) {
      var name = ele.slice(2);

      if (name && name[0]) {
        eventDict[ele] = name.replace(name[0], name[0].toLowerCase());
      }
    });
    return eventDict;
  } // http://codemirror.net/doc/manual.html#config


  function setOptions(_x) {
    return _setOptions.apply(this, arguments);
  }

  function _setOptions() {
    _setOptions = (0, _asyncToGenerator2.default)( /*#__PURE__*/_regenerator.default.mark(function _callee(instance) {
      var opt,
          mode,
          _args = arguments;
      return _regenerator.default.wrap(function _callee$(_context) {
        while (1) {
          switch (_context.prev = _context.next) {
            case 0:
              opt = _args.length > 1 && _args[1] !== undefined ? _args[1] : {};

              if (!((0, _typeof2.default)(opt) === 'object' && window)) {
                _context.next = 8;
                break;
              }

              mode = _codemirror.default.findModeByName(opt.mode || '');

              if (!(lazyLoadMode && mode && mode.mode)) {
                _context.next = 6;
                break;
              }

              _context.next = 6;
              return Promise.resolve("codemirror/mode/".concat(mode.mode, "/").concat(mode.mode, ".js")).then(function (s) {
                return (0, _interopRequireWildcard2.default)(require(s));
              });

            case 6:
              if (mode) {
                opt.mode = mode.mime;
              }

              Object.keys(opt).forEach(function (name) {
                if ((opt[name] || opt[name] === false) && JSON.stringify(opt[name])) {
                  instance.setOption(name, opt[name]);
                }
              });

            case 8:
            case "end":
              return _context.stop();
          }
        }
      }, _callee);
    }));
    return _setOptions.apply(this, arguments);
  }

  (0, _react.useEffect)(function () {
    if (!editor && window) {
      // 生成codemirror实例
      var instance = _codemirror.default.fromTextArea(textareaRef.current, (0, _objectSpread2.default)((0, _objectSpread2.default)({}, defaultOptions), options));

      var eventDict = getEventHandleFromProps();
      Object.keys(eventDict).forEach(function (event) {
        instance.on(eventDict[event], function () {
          var _lastestProps$current;

          return (_lastestProps$current = lastestProps.current)[event].apply(_lastestProps$current, arguments);
        });
      });
      instance.setValue(value || '');

      if (width || height) {
        // 设置尺寸
        instance.setSize(width, height);
      }

      setEditor(instance);
      setOptions(instance, (0, _objectSpread2.default)((0, _objectSpread2.default)({}, defaultOptions), options));
    }

    return function () {
      if (editor && window) {
        editor.toTextArea();
        setEditor(undefined);
      }
    };
  }, []);
  (0, _react.useMemo)(function () {
    if (!editor || !window) return;
    var val = editor.getValue();

    if (value !== undefined && value !== val) {
      editor.setValue(value);
    }
  }, [value]);
  (0, _react.useMemo)(function () {
    if (!editor || !window) return;
    editor.setSize(width, height);
  }, [width, height]);
  (0, _react.useMemo)(function () {
    if (!editor || !window) return;
    setOptions(editor, (0, _objectSpread2.default)((0, _objectSpread2.default)({}, defaultOptions), options));
  }, [editor, options]);
  return /*#__PURE__*/_react.default.createElement("textarea", {
    ref: textareaRef
  });
}

var _default = /*#__PURE__*/_react.default.forwardRef(ReactCodeMirror);

exports.default = _default;
module.exports = exports.default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJkZWZhdWx0T3B0aW9ucyIsInRhYlNpemUiLCJhdXRvQ2xvc2VCcmFja2V0cyIsIm1hdGNoQnJhY2tldHMiLCJzaG93Q3Vyc29yV2hlblNlbGVjdGluZyIsImxpbmVOdW1iZXJzIiwiZnVsbFNjcmVlbiIsIlJlYWN0Q29kZU1pcnJvciIsInByb3BzIiwicmVmIiwib3B0aW9ucyIsInZhbHVlIiwid2lkdGgiLCJoZWlnaHQiLCJsYXp5TG9hZE1vZGUiLCJlZGl0b3IiLCJzZXRFZGl0b3IiLCJ0ZXh0YXJlYVJlZiIsImxhc3Rlc3RQcm9wcyIsImN1cnJlbnQiLCJnZXRFdmVudEhhbmRsZUZyb21Qcm9wcyIsInByb3BOYW1lcyIsIk9iamVjdCIsImtleXMiLCJldmVudEhhbmRsZSIsImZpbHRlciIsImtleU5hbWUiLCJ0ZXN0IiwiZXZlbnREaWN0IiwiZm9yRWFjaCIsImVsZSIsIm5hbWUiLCJzbGljZSIsInJlcGxhY2UiLCJ0b0xvd2VyQ2FzZSIsInNldE9wdGlvbnMiLCJpbnN0YW5jZSIsIm9wdCIsIndpbmRvdyIsIm1vZGUiLCJDb2RlTWlycm9yIiwiZmluZE1vZGVCeU5hbWUiLCJtaW1lIiwiSlNPTiIsInN0cmluZ2lmeSIsInNldE9wdGlvbiIsImZyb21UZXh0QXJlYSIsImV2ZW50Iiwib24iLCJzZXRWYWx1ZSIsInNldFNpemUiLCJ0b1RleHRBcmVhIiwidW5kZWZpbmVkIiwidmFsIiwiZ2V0VmFsdWUiLCJSZWFjdCIsImZvcndhcmRSZWYiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBR0EsSUFBTUEsY0FBYyxHQUFHO0FBQ3JCQyxFQUFBQSxPQUFPLEVBQUUsQ0FEWTtBQUVyQkMsRUFBQUEsaUJBQWlCLEVBQUUsSUFGRTtBQUdyQkMsRUFBQUEsYUFBYSxFQUFFLElBSE07QUFJckJDLEVBQUFBLHVCQUF1QixFQUFFLElBSko7QUFLckI7QUFD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QWlCakQsZUFBakIsQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBSZWFjdCwgeyB1c2VSZWYsIHVzZUVmZmVjdCwgdXNlSW1wZXJhdGl2ZUhhbmRsZSwgdXNlU3RhdGUsIHVzZU1lbW8gfSBmcm9tICdyZWFjdCc7XG5pbXBvcnQgQ29kZU1pcnJvciBmcm9tICdjb2RlbWlycm9yJztcbmltcG9ydCAnY29kZW1pcnJvci9tb2RlL21ldGEnO1xuaW1wb3J0ICcuL2NvZGVtaXJyb3IuY3NzJztcblxuY29uc3QgZGVmYXVsdE9wdGlvbnMgPSB7XG4gIHRhYlNpemU6IDIsXG4gIGF1dG9DbG9zZUJyYWNrZXRzOiB0cnVlLFxuICBtYXRjaEJyYWNrZXRzOiB0cnVlLFxuICBzaG93Q3Vyc29yV2hlblNlbGVjdGluZzogdHJ1ZSxcbiAgLy8g5pi+56S66KGM5Y+3XG4gIGxpbmVOdW1iZXJzOiB0cnVlLFxuICBmdWxsU2NyZWVuOiB0cnVlLFxufVxuXG5mdW5jdGlvbiBSZWFjdENvZGVNaXJyb3IocHJvcHMgPSB7fSwgcmVmKSB7XG4gIGNvbnN0IHsgb3B0aW9ucyA9IHt9LCB2YWx1ZSA9ICcnLCB3aWR0aCA9ICcxMDAlJywgaGVpZ2h0ID0gJzEwMCUnLCBsYXp5TG9hZE1vZGUgPSB0cnVlIH0gPSBwcm9wcztcbiAgY29uc3QgW2VkaXRvciwgc2V0RWRpdG9yXSA9IHVzZVN0YXRlKCk7XG4gIGNvbnN0IHRleHRhcmVhUmVmID0gdXNlUmVmKCk7XG4gIGNvbnN0IGxhc3Rlc3RQcm9wcyA9IHVzZVJlZihwcm9wcyk7XG5cbiAgdXNlSW1wZXJhdGl2ZUhhbmRsZShyZWYsICgpID0+ICh7IGVkaXRvciB9KSwgW2VkaXRvcl0pO1xuICBsYXN0ZXN0UHJvcHMuY3VycmVudCA9IHByb3BzO1xuICBcbiAgLy8g5bCGcHJvcHPkuK3miYDmnInnmoTkuovku7blpITnkIblh73mlbDmmKDlsITlubbkv53lrZhcbiAgZnVuY3Rpb24gZ2V0RXZlbnRIYW5kbGVGcm9tUHJvcHMoKSB7XG4gICAgY29uc3QgcHJvcE5hbWVzID0gT2JqZWN0LmtleXMocHJvcHMpO1xuICAgIGNvbnN0IGV2ZW50SGFuZGxlID0gcHJvcE5hbWVzLmZpbHRlcigoa2V5TmFtZSkgPT4ge1xuICAgICAgcmV0dXJuIC9eb24rLy50ZXN0KGtleU5hbWUpO1xuICAgIH0pO1xuXG4gICAgY29uc3QgZXZlbnREaWN0ID0ge307XG4gICAgZXZlbnRIYW5kbGUuZm9yRWFjaCgoZWxlKSA9PiB7XG4gICAgICBjb25zdCBuYW1lID0gZWxlLnNsaWNlKDIpO1xuICAgICAgaWYgKG5hbWUgJiYgbmFtZVswXSkge1xuICAgICAgICBldmVudERpY3RbZWxlXSA9IG5hbWUucmVwbGFjZShuYW1lWzBdLCBuYW1lWzBdLnRvTG93ZXJDYXNlKCkpO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGV2ZW50RGljdDtcbiAgfVxuXG4gIC8vIGh0dHA6Ly9jb2RlbWlycm9yLm5ldC9kb2MvbWFudWFsLmh0bWwjY29uZmlnXG4gIGFzeW5jIGZ1bmN0aW9uIHNldE9wdGlvbnMoaW5zdGFuY2UsIG9wdCA9IHt9KSB7XG4gICAgaWYgKHR5cGVvZiBvcHQgPT09ICdvYmplY3QnICYmIHdpbmRvdykge1xuICAgICAgY29uc3QgbW9kZSA9IENvZGVNaXJyb3IuZmluZE1vZGVCeU5hbWUob3B0Lm1vZGUgfHwgJycpO1xuICAgICAgaWYgKGxhenlMb2FkTW9kZSAmJiBtb2RlICYmIG1vZGUubW9kZSkge1xuICAgICAgICBhd2FpdCBpbXBvcnQoYGNvZGVtaXJyb3IvbW9kZS8ke21vZGUubW9kZX0vJHttb2RlLm1vZGV9LmpzYCk7XG4gICAgICB9XG4gICAgICBpZiAobW9kZSkge1xuICAgICAgICBvcHQubW9kZSA9IG1vZGUubWltZTtcbiAgICAgIH1cbiAgICAgIE9iamVjdC5rZXlzKG9wdCkuZm9yRWFjaCgobmFtZSkgPT4ge1xuICAgICAgICBpZiAoKG9wdFtuYW1lXSB8fCBvcHRbbmFtZV0gPT09IGZhbHNlKSAmJiBKU09OLnN0cmluZ2lmeShvcHRbbmFtZV0pKSB7XG4gICAgICAgICAgaW5zdGFuY2Uuc2V0T3B0aW9uKG5hbWUsIG9wdFtuYW1lXSk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHVzZUVmZmVjdCgoKSA9PiB7XG4gICAgaWYgKCFlZGl0b3IgJiYgd2luZG93KSB7XG4gICAgICAvLyDnlJ/miJBjb2RlbWlycm9y5a6e5L6LXG4gICAgICBjb25zdCBpbnN0YW5jZSA9IENvZGVNaXJyb3IuZnJvbVRleHRBcmVhKHRleHRhcmVhUmVmLmN1cnJlbnQsIHsuLi5kZWZhdWx0T3B0aW9ucywgLi4ub3B0aW9uc30pO1xuICAgICAgY29uc3QgZXZlbnREaWN0ID0gZ2V0RXZlbnRIYW5kbGVGcm9tUHJvcHMoKTtcbiAgICAgIE9iamVjdC5rZXlzKGV2ZW50RGljdCkuZm9yRWFjaCgoZXZlbnQpID0+IHtcbiAgICAgICAgaW5zdGFuY2Uub24oZXZlbnREaWN0W2V2ZW50XSwgKC4uLnBhcmFtcykgPT4gbGFzdGVzdFByb3BzLmN1cnJlbnRbZXZlbnRdKC4uLnBhcmFtcykpO1xuICAgICAgfSk7XG4gICAgICBpbnN0YW5jZS5zZXRWYWx1ZSh2YWx1ZSB8fCAnJyk7XG5cbiAgICAgIGlmICh3aWR0aCB8fCBoZWlnaHQpIHtcbiAgICAgICAgLy8g6K6+572u5bC65a+4XG4gICAgICAgIGluc3RhbmNlLnNldFNpemUod2lkdGgsIGhlaWdodCk7XG4gICAgICB9XG4gICAgICBzZXRFZGl0b3IoaW5zdGFuY2UpO1xuICAgICAgc2V0T3B0aW9ucyhpbnN0YW5jZSwgey4uLmRlZmF1bHRPcHRpb25zLCAuLi5vcHRpb25zfSk7XG4gICAgfVxuICAgIHJldHVybiAoKSA9PiB7XG4gICAgICBpZiAoZWRpdG9yICYmIHdpbmRvdykge1xuICAgICAgICBlZGl0b3IudG9UZXh0QXJlYSgpO1xuICAgICAgICBzZXRFZGl0b3IodW5kZWZpbmVkKTtcbiAgICAgIH1cbiAgICB9XG4gIH0sIFtdKTtcblxuICB1c2VNZW1vKCgpID0+IHtcbiAgICBpZiAoIWVkaXRvciB8fCAhd2luZG93KSByZXR1cm47XG4gICAgY29uc3QgdmFsID0gZWRpdG9yLmdldFZhbHVlKCk7XG4gICAgaWYgKHZhbHVlICE9PSB1bmRlZmluZWQgJiYgdmFsdWUgIT09IHZhbCkge1xuICAgICAgZWRpdG9yLnNldFZhbHVlKHZhbHVlKTtcbiAgICB9XG4gIH0sIFt2YWx1ZV0pO1xuXG4gIHVzZU1lbW8oKCkgPT4ge1xuICAgIGlmICghZWRpdG9yIHx8ICF3aW5kb3cpIHJldHVybjtcbiAgICBlZGl0b3Iuc2V0U2l6ZSh3aWR0aCwgaGVpZ2h0KTtcbiAgfSwgW3dpZHRoLCBoZWlnaHRdKTtcblxuXG4gIHVzZU1lbW8oKCkgPT4ge1xuICAgIGlmICghZWRpdG9yIHx8ICF3aW5kb3cpIHJldHVybjtcbiAgICBzZXRPcHRpb25zKGVkaXRvciwgey4uLmRlZmF1bHRPcHRpb25zLCAuLi5vcHRpb25zfSk7XG4gIH0sIFtlZGl0b3IsIG9wdGlvbnNdKTtcbiAgXG4gIHJldHVybiAoXG4gICAgPHRleHRhcmVhIHJlZj17dGV4dGFyZWFSZWZ9IC8+XG4gICk7XG59XG5cbmV4cG9ydCBkZWZhdWx0IFJlYWN0LmZvcndhcmRSZWYoUmVhY3RDb2RlTWlycm9yKTtcbiJdfQ==